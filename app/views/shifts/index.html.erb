<%# app/views/shifts/index.html.erb %>

<div class="min-h-screen bg-gray-100">
  <!-- ヘッダー -->
  <header class="bg-gradient-to-r from-blue-600 to-blue-800 text-white py-4 px-6 shadow-lg">
    <h1 class="text-xl font-bold">🏥 応援シフト管理システム</h1>
    <p class="text-sm opacity-90">過不足自動算出</p>
  </header>

  <div class="max-w-7xl mx-auto px-4 py-6">
    <!-- サマリーカード -->
    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
      <div class="bg-white rounded-xl p-4 shadow border-l-4 border-red-500">
        <div class="text-xs text-gray-500">不足店舗</div>
        <div class="text-2xl font-bold text-red-500"><%= @shortage_data[:summary][:shortage_stores] %></div>
      </div>
      <div class="bg-white rounded-xl p-4 shadow border-l-4 border-green-500">
        <div class="text-xs text-gray-500">余剰店舗</div>
        <div class="text-2xl font-bold text-green-500"><%= @shortage_data[:summary][:surplus_stores] %></div>
      </div>
      <div class="bg-white rounded-xl p-4 shadow border-l-4 border-yellow-500">
        <div class="text-xs text-gray-500">要調整（薬剤師）</div>
        <div class="text-2xl font-bold text-yellow-600"><%= @shortage_data[:summary][:total_pharmacist_shortage] %>名</div>
      </div>
      <div class="bg-white rounded-xl p-4 shadow border-l-4 border-blue-500">
        <div class="text-xs text-gray-500">要調整（事務）</div>
        <div class="text-2xl font-bold text-blue-500"><%= @shortage_data[:summary][:total_clerk_shortage] %>名</div>
      </div>
    </div>

    <!-- ナビゲーション -->
    <div class="flex flex-wrap gap-2 mb-4">
      <%= link_to shifts_path(date: @date), class: "px-4 py-2 bg-blue-600 text-white rounded-lg text-sm font-medium" do %>
        日別ビュー
      <% end %>
      <%= link_to weekly_shifts_path(start_date: @date.beginning_of_week), class: "px-4 py-2 bg-white text-gray-700 rounded-lg text-sm font-medium hover:bg-gray-50" do %>
        週間一覧
      <% end %>
      <%= link_to suggestions_shifts_path(date: @date), class: "px-4 py-2 bg-purple-600 text-white rounded-lg text-sm font-medium" do %>
        🤖 AI提案
      <% end %>
      <%= link_to new_import_path, class: "px-4 py-2 bg-gray-600 text-white rounded-lg text-sm font-medium" do %>
        📥 CSVインポート
      <% end %>
    </div>

    <!-- 日付ナビ -->
    <div class="bg-white rounded-xl p-4 shadow mb-6 flex items-center justify-between">
      <%= link_to shifts_path(date: @date - 1), class: "px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300" do %>
        ◀ 前日
      <% end %>
      <div class="text-lg font-bold">
        <%= @date.strftime('%Y年%-m月%-d日（%a）') %>
      </div>
      <%= link_to shifts_path(date: @date + 1), class: "px-4 py-2 bg-gray-200 rounded-lg hover:bg-gray-300" do %>
        翌日 ▶
      <% end %>
    </div>

    <!-- 店舗カード -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
      <% @shortage_data[:stores].each do |store| %>
        <% 
          border_color = case store[:status]
                         when :shortage then 'border-red-500'
                         when :surplus then 'border-green-500'
                         else 'border-gray-300'
                         end
          status_class = case store[:status]
                         when :shortage then 'bg-red-100 text-red-700'
                         when :surplus then 'bg-green-100 text-green-700'
                         else 'bg-gray-100 text-gray-600'
                         end
          status_text = case store[:status]
                        when :shortage then '不足'
                        when :surplus then '余剰'
                        else '充足'
                        end
        %>
        <div class="bg-white rounded-xl shadow overflow-hidden border-t-4 <%= border_color %>">
          <div class="p-4 border-b flex justify-between items-center">
            <span class="font-bold"><%= store[:name] %></span>
            <span class="px-3 py-1 rounded-full text-xs font-bold <%= status_class %>"><%= status_text %></span>
          </div>
          <div class="p-4">
            <div class="grid grid-cols-2 gap-4">
              <!-- 薬剤師 -->
              <div>
                <div class="text-xs text-gray-500 mb-1">💊 薬剤師</div>
                <div class="flex items-baseline gap-2">
                  <span class="text-2xl font-bold"><%= store[:pharmacist][:current] %></span>
                  <span class="text-gray-500">/ <%= store[:pharmacist][:required] %>名</span>
                  <% diff = store[:pharmacist][:diff] %>
                  <% diff_class = diff < 0 ? 'bg-red-100 text-red-700' : diff > 0 ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600' %>
                  <span class="px-2 py-0.5 rounded text-xs font-bold <%= diff_class %>">
                    <%= diff > 0 ? "+#{diff}" : diff %>
                  </span>
                </div>
                <div class="mt-2 flex flex-wrap gap-1">
                  <% store[:staff_list][:pharmacists].each do |name| %>
                    <span class="px-2 py-1 bg-blue-100 text-blue-700 rounded text-xs"><%= name %></span>
                  <% end %>
                </div>
              </div>
              <!-- 事務 -->
              <div>
                <div class="text-xs text-gray-500 mb-1">📋 事務</div>
                <div class="flex items-baseline gap-2">
                  <span class="text-2xl font-bold"><%= store[:clerk][:current] %></span>
                  <span class="text-gray-500">/ <%= store[:clerk][:required] %>名</span>
                  <% diff = store[:clerk][:diff] %>
                  <% diff_class = diff < 0 ? 'bg-red-100 text-red-700' : diff > 0 ? 'bg-green-100 text-green-700' : 'bg-gray-100 text-gray-600' %>
                  <span class="px-2 py-0.5 rounded text-xs font-bold <%= diff_class %>">
                    <%= diff > 0 ? "+#{diff}" : diff %>
                  </span>
                </div>
                <div class="mt-2 flex flex-wrap gap-1">
                  <% store[:staff_list][:clerks].each do |name| %>
                    <span class="px-2 py-1 bg-gray-100 text-gray-700 rounded text-xs"><%= name %></span>
                  <% end %>
                </div>
              </div>
            </div>
            
            <% if store[:status] == :shortage %>
              <div class="mt-4 p-3 bg-yellow-50 border-l-4 border-yellow-400 rounded">
                <div class="text-xs font-bold text-yellow-700 mb-1">💡 補填が必要です</div>
                <div class="text-xs text-yellow-600">
                  <% if store[:pharmacist][:diff] < 0 %>
                    薬剤師 <%= store[:pharmacist][:diff].abs %>名
                  <% end %>
                  <% if store[:clerk][:diff] < 0 %>
                    事務 <%= store[:clerk][:diff].abs %>名
                  <% end %>
                </div>
              </div>
            <% end %>
          </div>
        </div>
      <% end %>
    </div>
  </div>
</div>
